<!DOCTYPE html>
<html >
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>äº‘å¼¹å¹•è¯åº“</title>
  <meta content="lvlanxing" name="author">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="äº‘ç«¯,äº‘å¼¹å¹•,è¯åº“,å¼¹å¹•" name="Keywords">
  <link rel="shortcut icon" href="https://rawcdn.githack.com/popzoo/pop/9d4121eed5cbb035e55203b8a9e56a73dcf2e6bf/images/favicon.ico"> 
  <style type="text/css">
		body {
		  overflow: hidden;
		  background: url('https://coding.net/u/lvlanxing/p/popzoo/git/raw/master/pics/wolf-girl.jpg') no-repeat;
		  /*background: url('https://rawcdn.githack.com/popzoo/barrage/a441391396c95442e092725e65510ed9c809d169/pics/wolf-girl.jpg') no-repeat;*/
		  background-size:100% 100%;
		}
		canvas {
		  width: 100%;
		  height: 100%;
		}
  </style>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");document.write(unescape("%3Cspan style='display:none;' id='cnzz_stat_icon_1278032070'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1278032070%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
</script> 
</head>
<body>
	<a href="https://github.com/ownthink/robot/" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#444444; color:#FFAAAA; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg>
	<a href="https://github.com/wolf-scream/FirePowerSeek" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#444444; color:#FFFF77; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
	<div style=" height:30px; color:goldenrod; line-height:30px; margin-left: -150px; padding:5px 0 10px 50%; font-size:30px; font-family: Arial,Microsoft YaHei,'å®‹ä½“';">
		ğŸ¥äº‘å¼¹å¹•è¯åº“â€¢éƒ¨åˆ†ğŸ¥
		<span class="collapse" style="float: right;white-space: nowrap; margin-right: 60px;  font-size: 20px;"> 
		    <a class="nav-link" style="text-decoration:none;color: orange;" href="https://popzoo.github.io/zoo/">æ—¶å…‰è½´</a> â€¢
		    <a class="nav-link" style="text-decoration:none;color: orange;" href="https://popzoo.github.io/barrage/">äº‘å¼¹å¹•</a> â€¢
		    <a class="nav-link" style="text-decoration:none;color: orange;" href="https://popzoo.github.io/pop/giftshow.html">ç¤¼ç‰©ç§€</a> â€¢
		    <a class="nav-link" style="text-decoration:none;color: orange;" href="https://popzoo.github.io/pop/motorcade.html">è½¦é˜Ÿå±•</a> â€¢
		    <a class="nav-link" style="text-decoration:none;color: orange;" href="https://greasyfork.org/zh-CN/scripts/389379">GreaseFork</a>
		</span>
	</div>
	<div  style="position: absolute;left: 50%; top: 20%;line-height: 35px;  text-align: center;margin-left: -240px;">
		<!-- <p style="font-size: 34px;font-weight: 600;color: blue;margin-top: 20px;">æ–—é±¼ç”¨æˆ·è‡ªå®šä¹‰å¼¹å¹•</p> -->
		<h3 style="font-size: 23px;color: #00B2EE;">æ–—é±¼ç«åŠ›è„šæœ¬ç”¨æˆ·ä¸“æœ‰äº‘å¼¹å¹•,ä½¿ç”¨è¯·<a style="color: orange;" href="https://popzoo.github.io/zoo/danmuManual.html" target="_blank">å‚è€ƒè¿™é‡Œ</a></h3>
        <div style="font-size: 20px;text-align: left; background-color: rgba(202,225,255,0.6);border-radius: 4px;">
        	&nbsp;ä¸Šä¼ ç§æœ‰äº‘å¼¹å¹•ï¼š<input type="file" id="files" accept=".json" name="file" onchange="fileImport();" style="font-size: 20px;width:310px;"><br/>
        	<!-- <p class='header' id="fill_data_tag" style="font-size: 16px;background-color: rgba(53,53,53,0);">è‡ªå·±çš„äº‘å¼¹å¹•é“¾æ¥</p> -->
        	&nbsp;ä¸‹è½½ç§æœ‰äº‘å¼¹å¹•ï¼š<input type="search" id="seek_self_danmu" placeholder="è¯·è¾“å…¥æ‚¨çš„æ–—é±¼æ˜µç§°"  style="font-size: 20px; border-radius: 4px;">
        		<input type="submit" value="ä¸‹è½½" style="font-size: 18px;background-color: rgba(53,53,53,0.6);border-radius: 4px;" id="search_danmu"/>
                <div style="text-align: center;">ä¸Šä¼ ç§æœ‰äº‘å¼¹å¹•çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨è„šæœ¬çš„<a href="https://popzoo.github.io/zoo/hiddenFlower.html" target="_blank" style="text-decoration: none;font-size: 500;color: #C71585;">éšè—åŠŸèƒ½</a></div>
        </div>
	</div>
	<canvas></canvas> <!-- ç»˜å›¾ä¸»ä½“ -->
    <script  src="js/danmu.js"></script>
    <script src="https://coding.net/u/lvlanxing/p/popzoo/git/raw/master/js/cos-js-sdk-v5.min.js"></script>
    <script>
        //ç‚¹å‡»å¯¼å…¥æŒ‰é’®,ä½¿filesè§¦å‘ç‚¹å‡»äº‹ä»¶,ç„¶åå®Œæˆè¯»å–æ–‡ä»¶çš„æ“ä½œ
        document.getElementById("search_danmu").addEventListener('click',getCOS);
        function fileImport() {
            //è·å–è¯»å–æˆ‘æ–‡ä»¶çš„Fileå¯¹è±¡
            var selectedFile = document.getElementById('files').files[0];
            var name = selectedFile.name;//è¯»å–é€‰ä¸­æ–‡ä»¶çš„æ–‡ä»¶å
            var size = selectedFile.size;//è¯»å–é€‰ä¸­æ–‡ä»¶çš„å¤§å°
            var fileFlag = false;
            if(parseInt(size)>1024){
            	size = Math.ceil(size/1024)+"KB";
            }else if(parseInt(size)<1024){
            	size = size +"B";
            }else if(parseInt(size)>1024*1024){
            	size = Math.ceil(size/(1024*1024))+"MB";
            }
			console.info("æ–‡ä»¶å:"+name+"; å¤§å°:"+size);
			// console.info(name.substr(0,name.length-5));
            if(parseInt(selectedFile.size)<1024*1024*5 && name.substr(name.length-5)==".json"){
            	// è¿™é‡Œå¯¹æ¥æ’­é…±æŸ¥éªŒç”¨æˆ·åæŸ¥çœ‹ç”¨æˆ·çœŸä¼ª
                fetch('https://bojianger.com/data/api/common/search.do?keyword='+name.substr(0,name.length-5), {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                }).then(result => {
                    return result.json();
                }).then(json => {
                    // let json = JSON.parse(txt);
                    let userName = json.data.audienceVo.audience_name;
                    let level = json.data.audienceVo.level;
                    console.info("ç”¨æˆ·åï¼š"+userName+";ç­‰çº§ï¼š"+level)
                    if(userName == name.substr(0,name.length-5) && parseInt(level)>-1){
                    	// fileFlag = true;
            			var reader = new FileReader();//è¿™æ˜¯æ ¸å¿ƒ,è¯»å–æ“ä½œå°±æ˜¯ç”±å®ƒå®Œæˆ.
            			reader.readAsText(selectedFile);//è¯»å–æ–‡ä»¶çš„å†…å®¹,ä¹Ÿå¯ä»¥è¯»å–æ–‡ä»¶çš„URL,é»˜è®¤ç¼–ç utf-8
            			reader.onload = function () {
            			    //å½“è¯»å–å®Œæˆåå›è°ƒè¿™ä¸ªå‡½æ•°,ç„¶åæ­¤æ—¶æ–‡ä»¶çš„å†…å®¹å­˜å‚¨åˆ°äº†resultä¸­,ç›´æ¥æ“ä½œå³å¯
            			    // console.log(this.result);
            			    if(isJSON(this.result)){
            			    	console.info("JSONæ ¼å¼æ ¡éªŒæ­£ç¡®ï¼Œæ­£åœ¨ä¸Šä¼ ");
            			    	putCOS(this.result,name);
            			    }else{
            			    	alert('JSONæ–‡ä»¶æ ¼å¼æ ¡éªŒé”™è¯¯ï¼Œè¯·é‡æ–°ç¼–è¾‘JSONæ–‡ä»¶å†…å®¹ï¼');
            			    }
            			}
                    }
                }).catch(err => {
                	alert("æ–—é±¼ç”¨æˆ·åæ£€æµ‹ä¸å­˜åœ¨ï¼Œè¯·å°†æ–‡æœ¬åå‘½åä¸ºæ–—é±¼æ˜µç§°");
                    // console.error('REQUEST ERROR', err);
                })              	
            }else{
            	alert("è¯·ä¸Šä¼ ä¸å¤§äº5MBçš„jsonæ ¼å¼æ–‡ä»¶");
            }

        }
        // json validation
		function isJSON(str) {
		    if (typeof str == 'string') {
		        try {
		            var obj=JSON.parse(str);
		            if(typeof obj == 'object' && obj ){
		                return true;
		            }else{
		                return false;
		            }
		
		        } catch(e) {
		            console.log('errorï¼š'+str+'!!!'+e);
		            return false;
		        }
		    }
		    return false;
		} 
    	// ============================= COS Operate =========================
    	const region = 'ap-beijing', bucket = 'danmu-1253626683';// eslint-disable-next-line
    	var cos = new COS({SecretId: window.atob("QUtJRENBeFZ6RUp3VnNLY2VSZ05US3dNZGVRd0RHTkp3UGFw"),
    					   SecretKey: window.atob("VW95c1h2MXhlQ2FwdGQ4dVd1QkN5YTBEQXROaGxhOVI=")});
    	function putCOS(file, fileName){
    	    cos.putObject({//add one object
    	        Bucket: bucket,
    	        Region: region,
    	        Key: 'userDanmu/'+fileName,
    	        Body: file,
    	    }, function (err, data) {
    	        if(err){
    	            alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
    	            // console.error(err);
    	        }else{
    	        	alert('æ­å–œæ‚¨ï¼Œè‡ªå®šä¹‰å¼¹å¹•æˆåŠŸï¼Œèµ¶å¿«å»åˆ·æ–°è„šæœ¬é¡µé¢è¯•è¯•å§ï¼');
    	        	// let fillObj = document.getElementById("fill_data_tag");
    	        	// fillObj.setAttribute("style","font-size: 22px;background-color: rgba(53,53,53,0);");
    	        	// fillObj.innerText = "æ‚¨çš„äº‘å¼¹å¹•åœ°å€ä¸ºï¼š"+ data.Location;
    	        	// console.info(data);
    	        }
    	    });
    	}
    	// get cos
    	function getCOS(){
        	let nickName = document.getElementById("seek_self_danmu").value.trim();
    	    cos.getObject({//get one object
    	        Bucket: bucket,
    	        Region: region,
    	        Key: 'userDanmu/'+nickName+".json",
    	    }, function (err, data) {
    	        if(err){//create a new Array
    	        	alert("æ²¡æœ‰æ‰¾åˆ°è¯¥ç”¨æˆ·ååŒ¹é…äº‘å¼¹å¹•ï¼Œè¯·æ£€æŸ¥æ˜µç§°æ˜¯å¦æ­£ç¡®ï¼");
    	            console.error(err || data.Body);
    	        }else{//get old Array and add new item of fire room
    	            // console.info(data.Body);
    	            alert("å·²è·å–åˆ°æ‚¨çš„ä¸“å±äº‘å¼¹å¹•ï¼Œç‚¹å‡»åè‡ªåŠ¨ä¸‹è½½åˆ°æœ¬åœ°");
    	            saveJsonContent(data.Body,nickName+".json");
    	        }
    	    });
    	}
    	//download json file
    	function saveJsonContent (content, fileName) {
    	    let downLink = document.createElement('a')
    	    downLink.download = fileName;
    	    let blob = new Blob([content]);//å­—ç¬¦å†…å®¹è½¬æ¢ä¸ºblodåœ°å€
    	    downLink.href = URL.createObjectURL(blob);
    	    document.body.appendChild(downLink);// é“¾æ¥æ’å…¥åˆ°é¡µé¢
    	    downLink.click();
    	    document.body.removeChild(downLink);// ç§»é™¤ä¸‹è½½é“¾æ¥
    	}
    </script>    
</body>
</html>
